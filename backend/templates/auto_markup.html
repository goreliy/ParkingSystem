{% extends "base.html" %}

{% block title %}–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–∞—Ä–∫–æ–≤–∫–∏{% endblock %}

{% block content %}
<div class="card">
    <h2>ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö –º–µ—Å—Ç</h2>
    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ AI –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö –º–µ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞.</p>
</div>

<div class="card">
    <h2>–®–∞–≥ 1: –í—ã–±–æ—Ä –∑–æ–Ω—ã –∏ —Ä–µ–∂–∏–º–∞ –∞–Ω–∞–ª–∏–∑–∞</h2>
    
    <div class="form-group">
        <label>–ü–∞—Ä–∫–æ–≤–æ—á–Ω–∞—è –∑–æ–Ω–∞</label>
        <select id="space-select" class="form-control">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–æ–Ω—É...</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>–†–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞</label>
        <select id="analysis-mode" class="form-control">
            <option value="single">üöÄ –ë—ã—Å—Ç—Ä—ã–π (1 –∫–∞–¥—Ä, ~1 —Å–µ–∫)</option>
            <option value="average" selected>‚ö° –£—Å—Ä–µ–¥–Ω–µ–Ω–Ω—ã–π (30 —Å–µ–∫, —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏)</option>
            <option value="duration">üî¨ –ì–ª—É–±–æ–∫–∏–π (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)</option>
        </select>
    </div>
    
    <div id="duration-settings" style="display: none;">
        <div class="form-group">
            <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞ (—Å–µ–∫—É–Ω–¥—ã)</label>
            <input type="number" id="duration-seconds" min="60" max="600" value="120">
            <small style="color: #666;">60-600 —Å–µ–∫—É–Ω–¥ (1-10 –º–∏–Ω—É—Ç)</small>
        </div>
    </div>
    
    <div class="form-group">
        <label>–ó–∞–ø–∞—Å –ø–æ —à–∏—Ä–∏–Ω–µ (%)</label>
        <input type="number" id="spot-width" min="100" max="200" value="120" step="5">
        <small style="color: #666;">100% = —Ç–æ—á–Ω–æ –ø–æ –º–∞—à–∏–Ω–µ, 120% = +20% –∑–∞–ø–∞—Å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</small>
    </div>
    
    <div class="form-group">
        <label>–ó–∞–ø–∞—Å –ø–æ –≤—ã—Å–æ—Ç–µ (%)</label>
        <input type="number" id="spot-height" min="100" max="200" value="120" step="5">
        <small style="color: #666;">100% = —Ç–æ—á–Ω–æ –ø–æ –º–∞—à–∏–Ω–µ, 120% = +20% –∑–∞–ø–∞—Å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</small>
    </div>
    
    <div class="form-group">
        <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (—Å–µ–∫—É–Ω–¥—ã)</label>
        <input type="number" id="stability-seconds" min="10" max="120" value="30">
        <small style="color: #666;">–ö–∞–∫ –¥–æ–ª–≥–æ –º–∞—à–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ —Å—Ç–æ—è—Ç—å –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ</small>
    </div>
    
    <button class="btn btn-success" onclick="startAnalysis()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
</div>

<div id="analysis-progress" class="card" style="display: none;">
    <h2>–ê–Ω–∞–ª–∏–∑ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...</h2>
    
    <div style="margin-bottom: 1rem;">
        <div style="background: #e0e0e0; border-radius: 4px; height: 30px; position: relative; overflow: hidden;">
            <div id="progress-bar" style="background: #27ae60; height: 100%; width: 0%; transition: width 0.3s;"></div>
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold;">
                <span id="progress-text">0%</span>
            </div>
        </div>
    </div>
    
    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="status-text">–ê–Ω–∞–ª–∏–∑...</span></p>
    <p><strong>–ö–∞–¥—Ä–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:</strong> <span id="frames-count">0</span></p>
    <p><strong>–ù–∞–π–¥–µ–Ω–æ –º–∞—à–∏–Ω:</strong> <span id="vehicles-count">0</span></p>
    
    <button class="btn btn-danger" onclick="cancelAnalysis()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
</div>

<div id="proposals-section" class="card" style="display: none;">
    <h2>–®–∞–≥ 2: –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h2>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div>
            <h3>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
            <img id="preview-image" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" style="width: 100%; border: 1px solid #ddd; border-radius: 4px;">
            <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #666;">
                üü¢ –ó–µ–ª–µ–Ω—ã–µ - –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞<br>
                üî¥ –ö—Ä–∞—Å–Ω—ã–µ - –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞
            </p>
        </div>
        
        <div>
            <h3>–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (<span id="proposals-count">0</span>)</h3>
            <div style="margin-bottom: 1rem;">
                <button class="btn" onclick="selectAllProposals()">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                <button class="btn" onclick="deselectAllProposals()">–°–Ω—è—Ç—å –≤—Å–µ</button>
            </div>
            
            <div id="proposals-list" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
    </div>
    
    <div style="border-top: 1px solid #ddd; padding-top: 1rem;">
        <h3>–®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Å—Ç</h3>
        
        <div class="form-group">
            <label>–ü—Ä–µ—Ñ–∏–∫—Å –º–µ—Ç–æ–∫</label>
            <input type="text" id="label-prefix" value="A" maxlength="3" style="max-width: 100px;">
            <small style="color: #666;">–ù–∞–ø—Ä–∏–º–µ—Ä: A –¥–ª—è A1, A2, A3...</small>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" id="auto-number" checked style="width: auto; margin-right: 0.5rem;">
                –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫–≤–æ–∑–Ω—É—é –Ω—É–º–µ—Ä–∞—Ü–∏—é
            </label>
            <small style="color: #666; display: block; margin-left: 1.5rem;">
                –ú–µ—Å—Ç–∞ –±—É–¥—É—Ç –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å —É—á–µ—Ç–æ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
            </small>
        </div>
        
        <p><strong>–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ –º–µ—Å—Ç:</strong> <span id="approved-count">0</span></p>
        
        <button class="btn btn-success" onclick="applyProposals()" style="margin-right: 0.5rem;">
            –°–æ–∑–¥–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞
        </button>
        <button class="btn" onclick="resetAnalysis()">
            –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
        </button>
    </div>
</div>

<div id="success-section" class="card" style="display: none;">
    <h2>‚úÖ –ü–∞—Ä–∫–æ–≤–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã!</h2>
    <p><strong>–°–æ–∑–¥–∞–Ω–æ –º–µ—Å—Ç:</strong> <span id="created-count">0</span></p>
    <p><strong>ID –º–µ—Å—Ç:</strong> <span id="created-ids" style="font-family: monospace; font-size: 0.875rem;"></span></p>
    
    <div style="margin-top: 1.5rem;">
        <a href="/dashboard" class="btn btn-success">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a>
        <a href="/setup" class="btn">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ</a>
        <button class="btn" onclick="resetAnalysis()">–°–æ–∑–¥–∞—Ç—å –µ—â–µ –º–µ—Å—Ç–∞</button>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
let currentSessionId = null;
let progressInterval = null;
let proposals = [];

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–æ–Ω
async function loadSpaces() {
    try {
        const data = await apiRequest('/api/spaces');
        const select = document.getElementById('space-select');
        
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–æ–Ω—É...</option>' +
            data.spaces.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–æ–Ω: ' + error.message, 'error');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
document.getElementById('analysis-mode').addEventListener('change', function() {
    const mode = this.value;
    document.getElementById('duration-settings').style.display = 
        mode === 'duration' ? 'block' : 'none';
});

async function startAnalysis() {
    const spaceId = document.getElementById('space-select').value;
    const mode = document.getElementById('analysis-mode').value;
    const spotWidth = parseInt(document.getElementById('spot-width').value);
    const spotHeight = parseInt(document.getElementById('spot-height').value);
    const stabilitySeconds = parseInt(document.getElementById('stability-seconds').value);
    const durationSeconds = parseInt(document.getElementById('duration-seconds').value);
    
    if (!spaceId) {
        showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∑–æ–Ω—É', 'error');
        return;
    }
    
    try {
        // –°–∫—Ä—ã—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        document.getElementById('proposals-section').style.display = 'none';
        document.getElementById('success-section').style.display = 'none';
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
        document.getElementById('analysis-progress').style.display = 'block';
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('progress-text').textContent = '0%';
        
        // –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑
        const response = await apiRequest('/api/auto-markup/start', {
            method: 'POST',
            body: JSON.stringify({
                space_id: spaceId,
                mode: mode,
                duration_seconds: durationSeconds,
                standard_spot_width: spotWidth,
                standard_spot_height: spotHeight,
                stability_seconds: stabilitySeconds
            })
        });
        
        currentSessionId = response.session_id;
        
        // –ù–∞—á–∞—Ç—å –æ–ø—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        progressInterval = setInterval(checkProgress, 1000);
        
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + error.message, 'error');
        document.getElementById('analysis-progress').style.display = 'none';
    }
}

async function checkProgress() {
    if (!currentSessionId) return;
    
    try {
        const progress = await apiRequest(`/api/auto-markup/progress/${currentSessionId}`);
        
        document.getElementById('progress-bar').style.width = progress.progress + '%';
        document.getElementById('progress-text').textContent = progress.progress + '%';
        document.getElementById('frames-count').textContent = progress.frames_analyzed;
        document.getElementById('vehicles-count').textContent = progress.vehicles_found;
        document.getElementById('status-text').textContent = 
            progress.status === 'analyzing' ? '–ê–Ω–∞–ª–∏–∑...' :
            progress.status === 'completed' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ!' :
            progress.status === 'error' ? '–û—à–∏–±–∫–∞: ' + progress.error_message :
            '–û—Ç–º–µ–Ω–µ–Ω–æ';
        
        if (progress.status === 'completed') {
            clearInterval(progressInterval);
            progressInterval = null;
            await loadProposals();
        } else if (progress.status === 'error' || progress.status === 'cancelled') {
            clearInterval(progressInterval);
            progressInterval = null;
            showAlert('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π –∏–ª–∏ –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω', 'error');
        }
        
    } catch (error) {
        console.error('Error checking progress:', error);
    }
}

async function loadProposals() {
    if (!currentSessionId) return;
    
    try {
        const data = await apiRequest(`/api/auto-markup/proposals/${currentSessionId}`);
        
        proposals = data.proposals;
        
        // –°–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        document.getElementById('analysis-progress').style.display = 'none';
        document.getElementById('proposals-section').style.display = 'block';
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        document.getElementById('preview-image').src = 
            `/api/auto-markup/preview/${currentSessionId}?t=${Date.now()}`;
        
        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
        renderProposalsList();
        
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: ' + error.message, 'error');
    }
}

function renderProposalsList() {
    const container = document.getElementById('proposals-list');
    document.getElementById('proposals-count').textContent = proposals.length;
    
    if (proposals.length === 0) {
        container.innerHTML = '<p>–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö –º–µ—Å—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞.</p>';
        return;
    }
    
    container.innerHTML = proposals.map((proposal, idx) => `
        <div class="proposal-item" style="padding: 0.75rem; border: 1px solid ${proposal.is_valid ? '#27ae60' : '#e74c3c'}; 
                                          border-radius: 4px; margin-bottom: 0.5rem; background: ${proposal.is_valid ? '#f0fff0' : '#fff0f0'};">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" 
                       id="proposal-${idx}" 
                       ${proposal.is_valid ? 'checked' : ''} 
                       onchange="toggleProposal(${idx}, this.checked)"
                       style="width: auto; margin-right: 0.5rem;">
                <div style="flex: 1;">
                    <strong>–ú–µ—Å—Ç–æ ${proposal.suggested_label}</strong>
                    <br>
                    <small>
                        –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(proposal.confidence * 100).toFixed(0)}% | 
                        –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: ${(proposal.stability_score * 100).toFixed(0)}%
                        ${proposal.exclude_reason ? `<br><span style="color: #e74c3c;">‚ö†Ô∏è ${proposal.exclude_reason}</span>` : ''}
                    </small>
                </div>
                <button class="btn ${proposal.is_valid ? 'btn-danger' : 'btn-success'}" 
                        onclick="event.stopPropagation(); excludeProposal(${idx}, ${!proposal.is_valid})"
                        style="margin-left: 0.5rem;">
                    ${proposal.is_valid ? '–ò—Å–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å'}
                </button>
            </label>
        </div>
    `).join('');
    
    updateApprovedCount();
}

function toggleProposal(index, checked) {
    proposals[index].is_valid = checked;
    updateApprovedCount();
}

async function excludeProposal(index, include) {
    try {
        const reason = include ? null : '–ò—Å–∫–ª—é—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º';
        
        await apiRequest(`/api/auto-markup/toggle-proposal/${currentSessionId}/${index}`, {
            method: 'PUT',
            body: JSON.stringify({
                is_valid: include,
                exclude_reason: reason
            })
        });
        
        proposals[index].is_valid = include;
        proposals[index].exclude_reason = reason;
        
        renderProposalsList();
        
        // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é
        document.getElementById('preview-image').src = 
            `/api/auto-markup/preview/${currentSessionId}?t=${Date.now()}`;
        
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ' + error.message, 'error');
    }
}

function selectAllProposals() {
    proposals.forEach((p, idx) => {
        if (p.is_valid) {
            const checkbox = document.getElementById(`proposal-${idx}`);
            if (checkbox) checkbox.checked = true;
        }
    });
    updateApprovedCount();
}

function deselectAllProposals() {
    proposals.forEach((p, idx) => {
        const checkbox = document.getElementById(`proposal-${idx}`);
        if (checkbox) checkbox.checked = false;
    });
    updateApprovedCount();
}

function updateApprovedCount() {
    const approved = proposals.filter((p, idx) => {
        const checkbox = document.getElementById(`proposal-${idx}`);
        return checkbox && checkbox.checked;
    }).length;
    
    document.getElementById('approved-count').textContent = approved;
}

async function applyProposals() {
    if (!currentSessionId) return;
    
    const approvedIndices = [];
    proposals.forEach((p, idx) => {
        const checkbox = document.getElementById(`proposal-${idx}`);
        if (checkbox && checkbox.checked) {
            approvedIndices.push(idx);
        }
    });
    
    if (approvedIndices.length === 0) {
        showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –º–µ—Å—Ç–æ', 'error');
        return;
    }
    
    if (!confirm(`–°–æ–∑–¥–∞—Ç—å ${approvedIndices.length} –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö –º–µ—Å—Ç?`)) {
        return;
    }
    
    try {
        const labelPrefix = document.getElementById('label-prefix').value;
        const autoNumber = document.getElementById('auto-number').checked;
        
        const result = await apiRequest('/api/auto-markup/apply', {
            method: 'POST',
            body: JSON.stringify({
                session_id: currentSessionId,
                approved_indices: approvedIndices,
                label_prefix: labelPrefix,
                auto_number: autoNumber
            })
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        document.getElementById('proposals-section').style.display = 'none';
        document.getElementById('success-section').style.display = 'block';
        document.getElementById('created-count').textContent = result.created_spots;
        document.getElementById('created-ids').textContent = result.spot_ids.join(', ');
        
        showAlert(`–£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ ${result.created_spots} –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã—Ö –º–µ—Å—Ç!`, 'success');
        
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Å—Ç: ' + error.message, 'error');
    }
}

async function cancelAnalysis() {
    if (!currentSessionId) return;
    
    try {
        await apiRequest(`/api/auto-markup/cancel/${currentSessionId}`, {
            method: 'DELETE'
        });
        
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
        
        document.getElementById('analysis-progress').style.display = 'none';
        showAlert('–ê–Ω–∞–ª–∏–∑ –æ—Ç–º–µ–Ω–µ–Ω', 'success');
        
        currentSessionId = null;
        
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∞–Ω–∞–ª–∏–∑–∞: ' + error.message, 'error');
    }
}

function resetAnalysis() {
    currentSessionId = null;
    proposals = [];
    
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
    
    document.getElementById('analysis-progress').style.display = 'none';
    document.getElementById('proposals-section').style.display = 'none';
    document.getElementById('success-section').style.display = 'none';
    
    // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-text').textContent = '0%';
    document.getElementById('frames-count').textContent = '0';
    document.getElementById('vehicles-count').textContent = '0';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
loadSpaces();
</script>
{% endblock %}

<style>
.proposal-item {
    transition: all 0.2s;
}

.proposal-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>

