{% extends "base.html" %}

{% block title %}–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ü–∞—Ä–∫–æ–≤–∫–∏{% endblock %}

{% block content %}
<div class="card">
    <h2>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞</h2>
    
    <div class="form-group">
        <label>–¢–æ–∫–µ–Ω –±–æ—Ç–∞</label>
        <input type="text" id="bot-token" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞">
        <small style="color: #666;">–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –≤ Telegram</small>
    </div>
    
    <button class="btn btn-success" onclick="saveBotToken()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
    <button class="btn" onclick="restartBot()">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞</button>
    
    <h3 style="margin-top: 1.5rem;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Ç—ã</h3>
    <p style="color: #666; margin-bottom: 1rem;">
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /start –±–æ—Ç—É. –í—ã–±–µ—Ä–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞. 
        <strong>–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ Telegram.</strong>
    </p>
    <div id="chats-list"></div>
</div>

<div class="card">
    <h2>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞</h2>
    
    <div class="form-group">
        <label>
            <input type="checkbox" id="streaming-enabled" style="width: auto; margin-right: 0.5rem;">
            –í–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥
        </label>
    </div>
    
    <div class="form-group">
        <label>–ü—É—Ç—å –∫ FFmpeg</label>
        <input type="text" id="ffmpeg-path" value="ffmpeg">
        <small style="color: #666;">–ü—É—Ç—å –∫ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–º—É —Ñ–∞–π–ª—É FFmpeg</small>
    </div>
    
    <h3 style="margin-top: 1.5rem;">–¶–µ–ª–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞</h3>
    <div id="targets-list"></div>
    
    <button class="btn btn-success" onclick="addTarget()" style="margin-top: 1rem;">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</button>
    <button class="btn" onclick="saveStreamingConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å—Ç—Ä–∏–º–∏–Ω–≥–∞</button>
</div>

<div class="card">
    <h2>ü§ñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ YOLO –º–æ–¥–µ–ª—è–º–∏</h2>
    <p style="margin-bottom: 1rem;">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞. –ë–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ —Ç–æ—á–Ω–µ–µ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ.</p>
    
    <div style="margin-bottom: 1.5rem;">
        <h3>–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å</h3>
        <div id="current-model-info" style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
    </div>
    
    <div style="margin-bottom: 1.5rem;">
        <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏</h3>
        <div id="models-list"></div>
    </div>
    
    <div style="margin-bottom: 1.5rem;">
        <h3>–¢–µ—Å—Ç –¥–µ—Ç–µ–∫—Ü–∏–∏</h3>
        <p style="color: #666; margin-bottom: 0.5rem;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏ –Ω–∞ –∫–∞–º–µ—Ä–µ</p>
        <select id="test-camera-select" class="form-control" style="max-width: 300px; margin-bottom: 0.5rem;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>
        </select>
        <button class="btn" onclick="testDetection()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–µ–∫—Ü–∏—é</button>
        <div id="test-results" style="margin-top: 1rem;"></div>
    </div>
</div>

<div class="card">
    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–æ—Å—Ç–∏</h2>
    
    <div class="form-group">
        <label>–ü–æ—Ä–æ–≥ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ (–º–∏–Ω—É—Ç—ã)</label>
        <input type="number" id="occupancy-minutes" min="1" max="60" value="5">
        <small style="color: #666;">–ö–∞–∫ –¥–æ–ª–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã —Å—á–∏—Ç–∞—Ç—å—Å—è "–∑–∞–Ω—è—Ç—ã–º"</small>
    </div>
    
    <div class="form-group">
        <label>–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–µ—Ç–µ–∫—Ü–∏–∏</label>
        <input type="number" id="confidence-threshold" min="0" max="1" step="0.05" value="0.5">
        <small style="color: #666;">–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ YOLO (0.0 - 1.0)</small>
    </div>
    
    <div class="form-group">
        <label>–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–ì—Ü)</label>
        <input type="number" id="update-hz" min="0.1" max="10" step="0.1" value="1.0">
        <small style="color: #666;">–ö–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (—Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É)</small>
    </div>
    
    <button class="btn btn-success" onclick="saveOccupancyConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

<div class="card">
    <h2>–°—Ç–∞—Ç—É—Å —Å—Ç—Ä–∏–º–∞</h2>
    <div id="stream-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div style="margin-top: 1rem;">
        <button class="btn btn-danger" onclick="stopActiveStream()">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç—Ä–∏–º</button>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
let streamingTargets = [];

async function loadConfig() {
    try {
        const config = await apiRequest('/api/config');
        const botConfig = await apiRequest('/api/config/bot');
        const streamingConfig = await apiRequest('/api/config/streaming');
        
        // Bot token (masked)
        if (botConfig.bot_token_set) {
            document.getElementById('bot-token').placeholder = '****** (–Ω–∞—Å—Ç—Ä–æ–µ–Ω)';
        }
        
        // Chats
        loadChats(botConfig.allowed_chats);
        
        // Streaming
        document.getElementById('streaming-enabled').checked = streamingConfig.enabled !== false;
        document.getElementById('ffmpeg-path').value = streamingConfig.ffmpeg_path || 'ffmpeg';
        streamingTargets = streamingConfig.targets || [];
        renderTargets();
        
        // Occupancy
        document.getElementById('occupancy-minutes').value = config.occupancy_minutes || 5;
        document.getElementById('confidence-threshold').value = config.confidence_threshold || 0.5;
        document.getElementById('update-hz').value = config.update_hz || 1.0;
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
    }
}

function loadChats(chats) {
    const list = document.getElementById('chats-list');
    
    if (!chats || chats.length === 0) {
        list.innerHTML = '<p>–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /start –±–æ—Ç—É –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.</p>';
        return;
    }
    
    list.innerHTML = `
        <table>
            <thead>
                <tr>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>ID —á–∞—Ç–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ê–¥–º–∏–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                ${chats.map(chat => `
                    <tr style="${chat.is_admin ? 'background: #e8f5e9;' : ''}">
                        <td>
                            <strong>${chat.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong>
                            ${chat.username ? `(@${chat.username})` : ''}
                        </td>
                        <td><code>${chat.chat_id}</code></td>
                        <td>
                            ${chat.is_admin ? 
                                '<span class="status-badge" style="background: #27ae60; color: white;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>' : 
                                '<span class="status-badge" style="background: #95a5a6; color: white;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>'
                            }
                        </td>
                        <td>
                            <input type="radio" name="admin-select" value="${chat.chat_id}" 
                                   ${chat.is_admin ? 'checked' : ''} 
                                   onchange="setAdmin(${chat.chat_id}, this.checked)">
                            <label style="margin-left: 0.5rem; cursor: pointer;">–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</label>
                        </td>
                        <td>
                            ${!chat.is_admin ? 
                                `<button class="btn btn-danger" onclick="removeChat(${chat.chat_id})">–£–¥–∞–ª–∏—Ç—å</button>` :
                                '<span style="color: #666;">–ê–¥–º–∏–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω</span>'
                            }
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

async function saveBotToken() {
    const token = document.getElementById('bot-token').value;
    
    if (!token) {
        showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞', 'error');
        return;
    }
    
    try {
        await apiRequest('/api/config/bot', {
            method: 'PUT',
            body: JSON.stringify({ bot_token: token })
        });
        
        showAlert('–¢–æ–∫–µ–Ω –±–æ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.', 'success');
        document.getElementById('bot-token').value = '';
        document.getElementById('bot-token').placeholder = '****** (–Ω–∞—Å—Ç—Ä–æ–µ–Ω)';
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ' + error.message, 'error');
    }
}

async function restartBot() {
    // Note: In practice, you'd need an endpoint to restart the bot
    showAlert('–§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', 'error');
}

async function setAdmin(chatId, isAdmin) {
    if (!isAdmin) {
        // If unchecking, don't allow - at least one admin should exist
        // Reload to reset radio button
        loadConfig();
        showAlert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'error');
        return;
    }
    
    try {
        // First, get all chats to unset other admins
        const botConfig = await apiRequest('/api/config/bot');
        const chats = botConfig.allowed_chats || [];
        
        // Unset all other admins
        for (const chat of chats) {
            if (chat.chat_id !== chatId && chat.is_admin) {
                await apiRequest(`/api/config/bot/chats/${chat.chat_id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ is_admin: false })
                });
            }
        }
        
        // Set new admin
        await apiRequest(`/api/config/bot/chats/${chatId}`, {
            method: 'PUT',
            body: JSON.stringify({ is_admin: true })
        });
        
        showAlert('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
        loadConfig();
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: ' + error.message, 'error');
        loadConfig();
    }
}

async function removeChat(chatId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö?')) return;
    
    try {
        await apiRequest(`/api/config/bot/chats/${chatId}`, { method: 'DELETE' });
        showAlert('–ß–∞—Ç —É–¥–∞–ª—ë–Ω', 'success');
        loadConfig();
    } catch (error) {
        let errorMsg = error.message;
        try {
            const errorData = JSON.parse(error.message);
            if (errorData.error) {
                errorMsg = errorData.error;
            }
        } catch (e) {
            // Use original message
        }
        showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞: ' + errorMsg, 'error');
        loadConfig();
    }
}

function renderTargets() {
    const list = document.getElementById('targets-list');
    
    if (streamingTargets.length === 0) {
        list.innerHTML = '<p>–¶–µ–ª–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.</p>';
        return;
    }
    
    list.innerHTML = streamingTargets.map((target, index) => `
        <div style="padding: 1rem; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 1rem;">
            <div class="form-group">
                <label>–ü—Å–µ–≤–¥–æ–Ω–∏–º</label>
                <input type="text" value="${target.alias || ''}" onchange="updateTarget(${index}, 'alias', this.value)">
            </div>
            <div class="form-group">
                <label>ID —á–∞—Ç–∞</label>
                <input type="number" value="${target.chat_id || ''}" onchange="updateTarget(${index}, 'chat_id', parseInt(this.value))">
            </div>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" value="${target.title || ''}" onchange="updateTarget(${index}, 'title', this.value)">
            </div>
            <div class="form-group">
                <label>RTMP URL</label>
                <input type="text" value="${target.rtmp_url || ''}" onchange="updateTarget(${index}, 'rtmp_url', this.value)">
            </div>
            <div class="form-group">
                <label>–ö–ª—é—á —Å—Ç—Ä–∏–º–∞</label>
                <input type="text" value="${target.stream_key || ''}" onchange="updateTarget(${index}, 'stream_key', this.value)">
            </div>
            <button class="btn btn-danger" onclick="removeTarget(${index})">–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å</button>
        </div>
    `).join('');
}

function updateTarget(index, field, value) {
    streamingTargets[index][field] = value;
}

function addTarget() {
    streamingTargets.push({
        alias: '–Ω–æ–≤–∞—è_—Ü–µ–ª—å',
        chat_id: 0,
        title: '–ù–æ–≤–∞—è —Ü–µ–ª—å',
        rtmp_url: '',
        stream_key: ''
    });
    renderTargets();
}

function removeTarget(index) {
    streamingTargets.splice(index, 1);
    renderTargets();
}

async function saveStreamingConfig() {
    try {
        const config = {
            enabled: document.getElementById('streaming-enabled').checked,
            ffmpeg_path: document.getElementById('ffmpeg-path').value,
            targets: streamingTargets,
            one_active_stream: true
        };
        
        await apiRequest('/api/config/streaming', {
            method: 'PUT',
            body: JSON.stringify(config)
        });
        
        showAlert('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞: ' + error.message, 'error');
    }
}

async function saveOccupancyConfig() {
    try {
        const config = {
            occupancy_minutes: parseInt(document.getElementById('occupancy-minutes').value),
            confidence_threshold: parseFloat(document.getElementById('confidence-threshold').value),
            update_hz: parseFloat(document.getElementById('update-hz').value)
        };
        
        await apiRequest('/api/config/occupancy', {
            method: 'PUT',
            body: JSON.stringify(config)
        });
        
        showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.', 'success');
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏: ' + error.message, 'error');
    }
}

async function loadStreamStatus() {
    try {
        const status = await apiRequest('/api/stream/status');
        const div = document.getElementById('stream-status');
        
        if (status.active) {
            const stream = status.stream;
            const started = new Date(stream.started_at * 1000).toLocaleString('ru-RU');
            div.innerHTML = `
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge status-occupied">–ê–∫—Ç–∏–≤–µ–Ω</span></p>
                <p><strong>–ö–∞–º–µ—Ä–∞:</strong> ${stream.camera_id}</p>
                <p><strong>–¶–µ–ª—å:</strong> ${stream.target_alias}</p>
                <p><strong>–ó–∞–ø—É—â–µ–Ω:</strong> ${started}</p>
                <p><strong>PID:</strong> ${stream.pid}</p>
            `;
        } else {
            div.innerHTML = '<p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge status-free">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∞</span></p>';
        }
    } catch (error) {
        document.getElementById('stream-status').innerHTML = '<p style="color: #e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞</p>';
    }
}

async function stopActiveStream() {
    try {
        await apiRequest('/api/stream/stop', { method: 'POST' });
        showAlert('–°—Ç—Ä–∏–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
        loadStreamStatus();
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç—Ä–∏–º–∞: ' + error.message, 'error');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π
async function loadModels() {
    try {
        const available = await apiRequest('/api/models/available');
        const current = await apiRequest('/api/models/current');
        const cameras = await apiRequest('/api/cameras');
        
        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å
        const currentInfo = document.getElementById('current-model-info');
        if (current.is_loaded) {
            currentInfo.innerHTML = `
                <p><strong>–ú–æ–¥–µ–ª—å:</strong> ${current.model_path}</p>
                <p><strong>–ó–∞–≥—Ä—É–∂–µ–Ω–∞:</strong> ${new Date(current.loaded_at).toLocaleString('ru-RU')}</p>
                <p><strong>–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:</strong> ${(current.confidence_threshold * 100).toFixed(0)}%</p>
                <p><strong>–ö–ª–∞—Å—Å—ã:</strong> ${current.vehicle_classes.join(', ')}</p>
            `;
        } else {
            currentInfo.innerHTML = '<p style="color: #e74c3c;">‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!</p>';
        }
        
        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π
        const modelsList = document.getElementById('models-list');
        if (available.models.length === 0) {
            modelsList.innerHTML = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π.</p>';
            return;
        }
        
        modelsList.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>–ú–æ–¥–µ–ª—å</th>
                        <th>–†–∞–∑–º–µ—Ä</th>
                        <th>–°–∫–æ—Ä–æ—Å—Ç—å</th>
                        <th>–¢–æ—á–Ω–æ—Å—Ç—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    ${available.models.map(model => `
                        <tr>
                            <td>
                                <strong>${model.name}</strong>
                                ${model.recommended ? ' <span class="status-badge status-free">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</span>' : ''}
                            </td>
                            <td>${model.size}</td>
                            <td>${model.speed}</td>
                            <td>${model.accuracy}</td>
                            <td>
                                ${model.is_downloaded ? 
                                    '<span class="status-badge status-online">–ó–∞–≥—Ä—É–∂–µ–Ω–∞</span>' : 
                                    '<span class="status-badge">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</span>'
                                }
                            </td>
                            <td>
                                ${model.is_downloaded ? 
                                    `<button class="btn btn-success" onclick="activateModel('${model.filename}')">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
                                     <button class="btn btn-danger" onclick="deleteModel('${model.filename}')">–£–¥–∞–ª–∏—Ç—å</button>` :
                                    `<button class="btn" onclick="downloadModel('${model.filename}')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>`
                                }
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–º–µ—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–∞
        const testSelect = document.getElementById('test-camera-select');
        testSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>' +
            cameras.cameras.map(cam => `<option value="${cam.id}">${cam.name}</option>`).join('');
        
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π: ' + error.message, 'error');
    }
}

async function downloadModel(filename) {
    if (!confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å ${filename}? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.`)) return;
    
    try {
        showAlert(`–ó–∞–≥—Ä—É–∑–∫–∞ ${filename}...`, 'success');
        
        const result = await apiRequest('/api/models/download', {
            method: 'POST',
            body: JSON.stringify({ filename })
        });
        
        showAlert(`–ú–æ–¥–µ–ª—å ${filename} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!`, 'success');
        loadModels();
        
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: ' + error.message, 'error');
    }
}

async function activateModel(filename) {
    if (!confirm(`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å ${filename}? –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –≤—ã–≥—Ä—É–∂–µ–Ω–∞.`)) return;
    
    try {
        const result = await apiRequest('/api/models/activate', {
            method: 'POST',
            body: JSON.stringify({ filename })
        });
        
        showAlert(`–ú–æ–¥–µ–ª—å ${filename} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!`, 'success');
        loadModels();
        
    } catch (error) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–π
        let errorMessage = error.message;
        
        try {
            const errorData = JSON.parse(error.message);
            if (errorData.requires_upgrade) {
                errorMessage = errorData.error || errorMessage;
                if (errorData.solution) {
                    errorMessage += `\n\n–†–ï–®–ï–ù–ò–ï: ${errorData.solution}`;
                }
            } else if (errorData.error) {
                errorMessage = errorData.error;
            }
        } catch (e) {
            // –ï—Å–ª–∏ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –Ω–∞ –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        if (errorMessage.includes('C3k2') || 
            errorMessage.includes('ultralytics') && errorMessage.includes('8.3.0') ||
            errorMessage.includes('—Ç—Ä–µ–±—É–µ—Ç ultralytics')) {
            errorMessage = `‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò –í–ï–†–°–ò–ô\n\n${errorMessage}\n\n` +
                          `–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è YOLOv11 –º–æ–¥–µ–ª–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å ultralytics:\n` +
                          `pip install --upgrade ultralytics>=8.3.0\n\n` +
                          `–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.`;
        }
        
        showAlert('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–æ–¥–µ–ª–∏: ' + errorMessage, 'error');
    }
}

async function deleteModel(filename) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –º–æ–¥–µ–ª—å ${filename}?`)) return;
    
    try {
        await apiRequest(`/api/models/delete/${filename}`, {
            method: 'DELETE'
        });
        
        showAlert(`–ú–æ–¥–µ–ª—å ${filename} —É–¥–∞–ª–µ–Ω–∞`, 'success');
        loadModels();
        
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏: ' + error.message, 'error');
    }
}

async function testDetection() {
    const cameraId = document.getElementById('test-camera-select').value;
    
    if (!cameraId) {
        showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É', 'error');
        return;
    }
    
    try {
        document.getElementById('test-results').innerHTML = '<p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...</p>';
        
        const result = await apiRequest('/api/models/test', {
            method: 'POST',
            body: JSON.stringify({ camera_id: cameraId })
        });
        
        const resultsDiv = document.getElementById('test-results');
        
        if (result.detections_count === 0) {
            resultsDiv.innerHTML = `
                <div style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                    <p><strong>‚ö†Ô∏è –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω!</strong></p>
                    <p>–ú–æ–¥–µ–ª—å: ${result.model_used}</p>
                    <p>–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏: ${(result.confidence_threshold * 100).toFixed(0)}%</p>
                    <p style="margin-top: 0.5rem;"><strong>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</strong></p>
                    <ul style="margin-left: 1.5rem;">
                        <li>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω—É—é –º–æ–¥–µ–ª—å (yolov8s –∏–ª–∏ yolov8m)</li>
                        <li>–°–Ω–∏–∑–∏—Ç—å –ø–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–æ 30-40%</li>
                        <li>–£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–∞ –ø–∞—Ä–∫–æ–≤–∫–µ –µ—Å—Ç—å –º–∞—à–∏–Ω—ã</li>
                        <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–∞–º–µ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</li>
                    </ul>
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div style="padding: 1rem; background: #d4edda; border: 1px solid #28a745; border-radius: 4px;">
                    <p><strong>‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: ${result.detections_count}</strong></p>
                    <p>–ú–æ–¥–µ–ª—å: ${result.model_used}</p>
                    <p>–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏: ${(result.confidence_threshold * 100).toFixed(0)}%</p>
                    <details style="margin-top: 0.5rem;">
                        <summary style="cursor: pointer; font-weight: bold;">–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏</summary>
                        <div style="margin-top: 0.5rem; font-family: monospace; font-size: 0.875rem;">
                            ${result.detections.map((det, idx) => `
                                <div style="padding: 0.25rem; border-bottom: 1px solid #ddd;">
                                    ${idx + 1}. ${det.class_name} - ${(det.confidence * 100).toFixed(0)}% 
                                    [${det.bbox.join(', ')}]
                                </div>
                            `).join('')}
                        </div>
                    </details>
                </div>
            `;
        }
        
    } catch (error) {
        document.getElementById('test-results').innerHTML = `
            <div style="padding: 1rem; background: #f8d7da; border: 1px solid #e74c3c; border-radius: 4px;">
                <p style="color: #721c24;"><strong>–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${error.message}</p>
            </div>
        `;
    }
}

// Initial load
loadConfig();
loadStreamStatus();
loadModels();
setInterval(loadStreamStatus, 5000);
</script>
{% endblock %}

